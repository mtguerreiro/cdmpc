/*
 * qp.c
 *
 *  Created on: 12.07.2021
 *      Author: mguerreiro
 *
 */

//=============================================================================
/*-------------------------------- Includes ---------------------------------*/
//=============================================================================
#include "qpfxp.h"

#include "ap_utils.h"

//=============================================================================

#define QPFXP_LAMBDA_SIZE	32
#define QPFXP_N_ITERS		10

//=============================================================================
/*-------------------------------- Functions --------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
uint32_t qpfxpHildFixedIter(fmint_t *H, fmint_t *K, uint32_t nIter, fmint_t* lambda, uint32_t lambdaSize){

	fmint_t *h;
	fmint_t *k;
    fmint_t acc;

	uint32_t n, i, j, m;

	for(i = 0; i < lambdaSize; i++){
		lambda[i] = 0;
	}

	n = 0;
	k = K;
	for(m = 0; m < nIter; m++){

		h = H;

		/* One iteration through the lambda vector */
		for(i = 0; i < lambdaSize; i++){

			lambda[i] = 0;
            acc = 0;
			for(j = 0; j < lambdaSize; j++){
				acc += fixedmul(h[j], lambda[j]);
			}

			lambda[i] = fixedmul(h[i], k[i] + acc);
			if( lambda[i] < 0 ) lambda[i] = 0;

			h = h + lambdaSize;
		}

		n++;
	}

	return n;
}
//-----------------------------------------------------------------------------
fmint_t dot(fmint_t *a, fmint_t *b){

	uint32_t i;
	volatile fmint_t acc;

	acc = 0;
	for(i = 0; i < QPFXP_LAMBDA_SIZE; i++){
		acc += fixedmul(a[i], b[i]);
	}

	return acc;
}
//-----------------------------------------------------------------------------
uint32_t qpfxpHildFixedIterHLS(fmint_t *K_if, fmint_t *lambda_if){

	static fmint_t H[32][32] = {{        -2,         0, -12155194,    549880,   3440790,   -431191,
		     7214965,   -786260,  -7389736,         0,  12155194,   -549880,
		    -3440790,    431191,  -7214965,    786260,   -276714,      5665,
		      241877,    -16806,     88557,     -4969,   -242257,     34581,
		      276714,     -5665,   -241877,     16806,    -88557,      4969,
		      242257,    -34581},
		 {         0,        -2,   -549880, -12155194,    431191,   3440790,
		      786260,   7214965,         0,  -7389736,    549880,  12155194,
		     -431191,  -3440790,   -786260,  -7214965,     -5665,   -276714,
		       16806,    241877,      4969,     88557,    -34581,   -242257,
		        5665,    276714,    -16806,   -241877,     -4969,    -88557,
		       34581,    242257},
		 { -12155194,   -549880,         0,         0, -25123935,   1332637,
		   -32273371,   1680008,  12155194,    549880, -31282304,         0,
		    25123935,  -1332637,  32273371,  -1680008,    455582,     11272,
		     -820284,     18269,    256954,    -26300,   1519407,   -128066,
		     -455582,    -11272,    820284,    -18269,   -256954,     26300,
		    -1519407,    128066},
		 {    549880, -12155194,         0,         0,  -1332637, -25123935,
		    -1680008, -32273371,   -549880,  12155194,         0, -31282304,
		     1332637,  25123935,   1680008,  32273371,    -11272,    455582,
		      -18269,   -820284,     26300,    256954,    128066,   1519407,
		       11272,   -455582,     18269,    820284,    -26300,   -256954,
		     -128066,  -1519407},
		 {   3440790,    431191, -25123935,  -1332637,         0,         0,
		    23267511,    864003,  -3440790,   -431191,  25123935,   1332637,
		   -46664049,         0, -23267511,   -864003,   -129173,    -13508,
		      841931,     24321,  -1083610,     28257,  -1807524,     46604,
		      129173,     13508,   -841931,    -24321,   1083610,    -28257,
		     1807524,    -46604},
		 {   -431191,   3440790,   1332637, -25123935,         0,         0,
		     -864003,  23267511,    431191,  -3440790,  -1332637,  25123935,
		           0, -46664049,    864003, -23267511,     13508,   -129173,
		      -24321,    841931,    -28257,  -1083610,    -46604,  -1807524,
		      -13508,    129173,     24321,   -841931,     28257,   1083610,
		       46604,   1807524},
		 {   7214965,    786260, -32273371,  -1680008,  23267511,   -864003,
		           0,         0,  -7214965,   -786260,  32273371,   1680008,
		   -23267511,    864003,-200946000,         0,   -270773,    -23911,
		     1000568,     28312,    -68405,     40622,  -7703185,    194052,
		      270773,     23911,  -1000568,    -28312,     68405,    -40622,
		     7703185,   -194052},
		 {   -786260,   7214965,   1680008, -32273371,    864003,  23267511,
		           0,         0,    786260,  -7214965,  -1680008,  32273371,
		     -864003, -23267511,         0,-200946000,     23911,   -270773,
		      -28312,   1000568,    -40622,    -68405,   -194052,  -7703185,
		      -23911,    270773,     28312,  -1000568,     40622,     68405,
		      194052,   7703185},
		 {  -7389736,         0,  12155194,   -549880,  -3440790,    431191,
		    -7214965,    786260,        -2,         0, -12155194,    549880,
		     3440790,   -431191,   7214965,   -786260,    276714,     -5665,
		     -241877,     16806,    -88557,      4969,    242257,    -34581,
		     -276714,      5665,    241877,    -16806,     88557,     -4969,
		     -242257,     34581},
		 {         0,  -7389736,    549880,  12155194,   -431191,  -3440790,
		     -786260,  -7214965,         0,        -2,   -549880, -12155194,
		      431191,   3440790,    786260,   7214965,      5665,    276714,
		      -16806,   -241877,     -4969,    -88557,     34581,    242257,
		       -5665,   -276714,     16806,    241877,      4969,     88557,
		      -34581,   -242257},
		 {  12155194,    549880, -31282304,         0,  25123935,  -1332637,
		    32273371,  -1680008, -12155194,   -549880,         0,         0,
		   -25123935,   1332637, -32273371,   1680008,   -455582,    -11272,
		      820284,    -18269,   -256954,     26300,  -1519407,    128066,
		      455582,     11272,   -820284,     18269,    256954,    -26300,
		     1519407,   -128066},
		 {   -549880,  12155194,         0, -31282304,   1332637,  25123935,
		     1680008,  32273371,    549880, -12155194,         0,         0,
		    -1332637, -25123935,  -1680008, -32273371,     11272,   -455582,
		       18269,    820284,    -26300,   -256954,   -128066,  -1519407,
		      -11272,    455582,    -18269,   -820284,     26300,    256954,
		      128066,   1519407},
		 {  -3440790,   -431191,  25123935,   1332637, -46664049,         0,
		   -23267511,   -864003,   3440790,    431191, -25123935,  -1332637,
		           0,         0,  23267511,    864003,    129173,     13508,
		     -841931,    -24321,   1083610,    -28257,   1807524,    -46604,
		     -129173,    -13508,    841931,     24321,  -1083610,     28257,
		    -1807524,     46604},
		 {    431191,  -3440790,  -1332637,  25123935,         0, -46664049,
		      864003, -23267511,   -431191,   3440790,   1332637, -25123935,
		           0,         0,   -864003,  23267511,    -13508,    129173,
		       24321,   -841931,     28257,   1083610,     46604,   1807524,
		       13508,   -129173,    -24321,    841931,    -28257,  -1083610,
		      -46604,  -1807524},
		 {  -7214965,   -786260,  32273371,   1680008, -23267511,    864003,
		  -200946000,         0,   7214965,    786260, -32273371,  -1680008,
		    23267511,   -864003,         0,         0,    270773,     23911,
		    -1000568,    -28312,     68405,    -40622,   7703185,   -194052,
		     -270773,    -23911,   1000568,     28312,    -68405,     40622,
		    -7703185,    194052},
		 {    786260,  -7214965,  -1680008,  32273371,   -864003, -23267511,
		           0,-200946000,   -786260,   7214965,   1680008, -32273371,
		      864003,  23267511,         0,         0,    -23911,    270773,
		       28312,  -1000568,     40622,     68405,    194052,   7703185,
		       23911,   -270773,    -28312,   1000568,    -40622,    -68405,
		     -194052,  -7703185},
		 {   -276714,     -5665,    455582,    -11272,   -129173,     13508,
		     -270773,     23911,    276714,      5665,   -455582,     11272,
		      129173,    -13508,    270773,    -23911,     -1618,         0,
		       -9070,       443,     -3319,       118,      9098,     -1109,
		      -10366,         0,      9070,      -443,      3319,      -118,
		       -9098,      1109},
		 {      5665,   -276714,     11272,    455582,    -13508,   -129173,
		      -23911,   -270773,     -5665,    276714,    -11272,   -455582,
		       13508,    129173,     23911,    270773,         0,     -1618,
		        -443,     -9070,      -118,     -3319,      1109,      9098,
		           0,    -10366,       443,      9070,       118,      3319,
		       -1109,     -9098},
		 {    241877,     16806,   -820284,    -18269,    841931,    -24321,
		     1000568,    -28312,   -241877,    -16806,    820284,     18269,
		     -841931,     24321,  -1000568,     28312,     -9070,      -443,
		        -706,         0,    -12201,       773,    -49954,      3064,
		        9070,       443,    -23733,         0,     12201,      -773,
		       49954,     -3064},
		 {    -16806,    241877,     18269,   -820284,     24321,    841931,
		       28312,   1000568,     16806,   -241877,    -18269,    820284,
		      -24321,   -841931,    -28312,  -1000568,       443,     -9070,
		           0,      -706,      -773,    -12201,     -3064,    -49954,
		        -443,      9070,         0,    -23733,       773,     12201,
		        3064,     49954},
		 {     88557,      4969,    256954,     26300,  -1083610,    -28257,
		      -68405,    -40622,    -88557,     -4969,   -256954,    -26300,
		     1083610,     28257,     68405,     40622,     -3319,      -118,
		      -12201,      -773,      -531,         0,     28120,       464,
		        3319,       118,     12201,       773,    -31558,         0,
		      -28120,      -464},
		 {     -4969,     88557,    -26300,    256954,     28257,  -1083610,
		       40622,    -68405,      4969,    -88557,     26300,   -256954,
		      -28257,   1083610,    -40622,     68405,       118,     -3319,
		         773,    -12201,         0,      -531,      -464,     28120,
		        -118,      3319,      -773,     12201,         0,    -31558,
		         464,    -28120},
		 {   -242257,    -34581,   1519407,    128066,  -1807524,    -46604,
		    -7703185,   -194052,    242257,     34581,  -1519407,   -128066,
		     1807524,     46604,   7703185,    194052,      9098,      1109,
		      -49954,     -3064,     28120,      -464,       -53,         0,
		       -9098,     -1109,     49954,      3064,    -28120,       464,
		     -316387,         0},
		 {     34581,   -242257,   -128066,   1519407,     46604,  -1807524,
		      194052,  -7703185,    -34581,    242257,    128066,  -1519407,
		      -46604,   1807524,   -194052,   7703185,     -1109,      9098,
		        3064,    -49954,       464,     28120,         0,       -53,
		        1109,     -9098,     -3064,     49954,      -464,    -28120,
		           0,   -316387},
		 {    276714,      5665,   -455582,     11272,    129173,    -13508,
		      270773,    -23911,   -276714,     -5665,    455582,    -11272,
		     -129173,     13508,   -270773,     23911,    -10366,         0,
		        9070,      -443,      3319,      -118,     -9098,      1109,
		       -1618,         0,     -9070,       443,     -3319,       118,
		        9098,     -1109},
		 {     -5665,    276714,    -11272,   -455582,     13508,    129173,
		       23911,    270773,      5665,   -276714,     11272,    455582,
		      -13508,   -129173,    -23911,   -270773,         0,    -10366,
		         443,      9070,       118,      3319,     -1109,     -9098,
		           0,     -1618,      -443,     -9070,      -118,     -3319,
		        1109,      9098},
		 {   -241877,    -16806,    820284,     18269,   -841931,     24321,
		    -1000568,     28312,    241877,     16806,   -820284,    -18269,
		      841931,    -24321,   1000568,    -28312,      9070,       443,
		      -23733,         0,     12201,      -773,     49954,     -3064,
		       -9070,      -443,      -706,         0,    -12201,       773,
		      -49954,      3064},
		 {     16806,   -241877,    -18269,    820284,    -24321,   -841931,
		      -28312,  -1000568,    -16806,    241877,     18269,   -820284,
		       24321,    841931,     28312,   1000568,      -443,      9070,
		           0,    -23733,       773,     12201,      3064,     49954,
		         443,     -9070,         0,      -706,      -773,    -12201,
		       -3064,    -49954},
		 {    -88557,     -4969,   -256954,    -26300,   1083610,     28257,
		       68405,     40622,     88557,      4969,    256954,     26300,
		    -1083610,    -28257,    -68405,    -40622,      3319,       118,
		       12201,       773,    -31558,         0,    -28120,      -464,
		       -3319,      -118,    -12201,      -773,      -531,         0,
		       28120,       464},
		 {      4969,    -88557,     26300,   -256954,    -28257,   1083610,
		      -40622,     68405,     -4969,     88557,    -26300,    256954,
		       28257,  -1083610,     40622,    -68405,      -118,      3319,
		        -773,     12201,         0,    -31558,       464,    -28120,
		         118,     -3319,       773,    -12201,         0,      -531,
		        -464,     28120},
		 {    242257,     34581,  -1519407,   -128066,   1807524,     46604,
		     7703185,    194052,   -242257,    -34581,   1519407,    128066,
		    -1807524,    -46604,  -7703185,   -194052,     -9098,     -1109,
		       49954,      3064,    -28120,       464,   -316387,         0,
		        9098,      1109,    -49954,     -3064,     28120,      -464,
		         -53,         0},
		 {    -34581,    242257,    128066,  -1519407,    -46604,   1807524,
		     -194052,   7703185,     34581,   -242257,   -128066,   1519407,
		       46604,  -1807524,    194052,  -7703185,      1109,     -9098,
		       -3064,     49954,      -464,    -28120,         0,   -316387,
		       -1109,      9098,      3064,    -49954,       464,     28120,
		           0,       -53}};

	fmint_t *h;
	fmint_t *k;
    volatile fmint_t acc;

	uint32_t n, i, j, m;

	fmint_t K[32];
	fmint_t lambda[32];

	for(i = 0; i < QPFXP_LAMBDA_SIZE; i++){
		K[i] = *K_if++;
	}

	for(i = 0; i < QPFXP_LAMBDA_SIZE; i++){
		lambda[i] = 0;
	}

	n = 0;
	k = K;
	for(m = 0; m < QPFXP_N_ITERS; m++){

		h = (fmint_t *)H;
		/* One iteration through the lambda vector */
		for(i = 0; i < QPFXP_LAMBDA_SIZE; i++){

			lambda[i] = 0;
			acc=0;

			for(j = 0; j < QPFXP_LAMBDA_SIZE; j++){
				acc += fixedmul(h[j], lambda[j]);
			}

			lambda[i] = fixedmul(h[i], k[i] + acc);
			if( lambda[i] < 0 ) lambda[i] = 0;

			h = h + QPFXP_LAMBDA_SIZE;
		}

		n++;
	}

	for(i = 0; i < QPFXP_LAMBDA_SIZE; i++){
		*lambda_if++ = lambda[i];
	}

	return n;
}
//-----------------------------------------------------------------------------
//=============================================================================
