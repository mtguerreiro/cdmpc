#include "qdldl_st.h"

static inline void QDLDL_Lsolve_st(const QDLDL_float Lx[46], QDLDL_float x[16]){

    QDLDL_float val;

   /*
    * i = 0
    * L_p[0] = 0, L_p[1] = 2
    */
    val = x[0];
    x[8] -= Lx[0] * val;
    x[10] -= Lx[1] * val;

   /*
    * i = 1
    * L_p[1] = 2, L_p[2] = 4
    */
    val = x[1];
    x[9] -= Lx[2] * val;
    x[15] -= Lx[3] * val;

   /*
    * i = 2
    * L_p[2] = 4, L_p[3] = 5
    */
    val = x[2];
    x[8] -= Lx[4] * val;

   /*
    * i = 3
    * L_p[3] = 5, L_p[4] = 6
    */
    val = x[3];
    x[9] -= Lx[5] * val;

   /*
    * i = 4
    * L_p[4] = 6, L_p[5] = 8
    */
    val = x[4];
    x[8] -= Lx[6] * val;
    x[9] -= Lx[7] * val;

   /*
    * i = 5
    * L_p[5] = 8, L_p[6] = 10
    */
    val = x[5];
    x[8] -= Lx[8] * val;
    x[9] -= Lx[9] * val;

   /*
    * i = 6
    * L_p[6] = 10, L_p[7] = 14
    */
    val = x[6];
    x[8] -= Lx[10] * val;
    x[9] -= Lx[11] * val;
    x[10] -= Lx[12] * val;
    x[15] -= Lx[13] * val;

   /*
    * i = 7
    * L_p[7] = 14, L_p[8] = 18
    */
    val = x[7];
    x[8] -= Lx[14] * val;
    x[9] -= Lx[15] * val;
    x[10] -= Lx[16] * val;
    x[15] -= Lx[17] * val;

   /*
    * i = 8
    * L_p[8] = 18, L_p[9] = 25
    */
    val = x[8];
    x[9] -= Lx[18] * val;
    x[10] -= Lx[19] * val;
    x[11] -= Lx[20] * val;
    x[12] -= Lx[21] * val;
    x[13] -= Lx[22] * val;
    x[14] -= Lx[23] * val;
    x[15] -= Lx[24] * val;

   /*
    * i = 9
    * L_p[9] = 25, L_p[10] = 31
    */
    val = x[9];
    x[10] -= Lx[25] * val;
    x[11] -= Lx[26] * val;
    x[12] -= Lx[27] * val;
    x[13] -= Lx[28] * val;
    x[14] -= Lx[29] * val;
    x[15] -= Lx[30] * val;

   /*
    * i = 10
    * L_p[10] = 31, L_p[11] = 36
    */
    val = x[10];
    x[11] -= Lx[31] * val;
    x[12] -= Lx[32] * val;
    x[13] -= Lx[33] * val;
    x[14] -= Lx[34] * val;
    x[15] -= Lx[35] * val;

   /*
    * i = 11
    * L_p[11] = 36, L_p[12] = 40
    */
    val = x[11];
    x[12] -= Lx[36] * val;
    x[13] -= Lx[37] * val;
    x[14] -= Lx[38] * val;
    x[15] -= Lx[39] * val;

   /*
    * i = 12
    * L_p[12] = 40, L_p[13] = 43
    */
    val = x[12];
    x[13] -= Lx[40] * val;
    x[14] -= Lx[41] * val;
    x[15] -= Lx[42] * val;

   /*
    * i = 13
    * L_p[13] = 43, L_p[14] = 45
    */
    val = x[13];
    x[14] -= Lx[43] * val;
    x[15] -= Lx[44] * val;

   /*
    * i = 14
    * L_p[14] = 45, L_p[15] = 46
    */
    val = x[14];
    x[15] -= Lx[45] * val;
}

static inline void QDLDL_Ltsolve_st(const QDLDL_float Lx[46], QDLDL_float x[16]){

    QDLDL_float val;

   /*
    * i = 14
    * L_p[14] = 45, L_p[15] = 46
    */
    val = x[14];
    val -= Lx[45] * x[15];
    x[14] = val;

   /*
    * i = 13
    * L_p[13] = 43, L_p[14] = 45
    */
    val = x[13];
    val -= Lx[43] * x[14];
    val -= Lx[44] * x[15];
    x[13] = val;

   /*
    * i = 12
    * L_p[12] = 40, L_p[13] = 43
    */
    val = x[12];
    val -= Lx[40] * x[13];
    val -= Lx[41] * x[14];
    val -= Lx[42] * x[15];
    x[12] = val;

   /*
    * i = 11
    * L_p[11] = 36, L_p[12] = 40
    */
    val = x[11];
    val -= Lx[36] * x[12];
    val -= Lx[37] * x[13];
    val -= Lx[38] * x[14];
    val -= Lx[39] * x[15];
    x[11] = val;

   /*
    * i = 10
    * L_p[10] = 31, L_p[11] = 36
    */
    val = x[10];
    val -= Lx[31] * x[11];
    val -= Lx[32] * x[12];
    val -= Lx[33] * x[13];
    val -= Lx[34] * x[14];
    val -= Lx[35] * x[15];
    x[10] = val;

   /*
    * i = 9
    * L_p[9] = 25, L_p[10] = 31
    */
    val = x[9];
    val -= Lx[25] * x[10];
    val -= Lx[26] * x[11];
    val -= Lx[27] * x[12];
    val -= Lx[28] * x[13];
    val -= Lx[29] * x[14];
    val -= Lx[30] * x[15];
    x[9] = val;

   /*
    * i = 8
    * L_p[8] = 18, L_p[9] = 25
    */
    val = x[8];
    val -= Lx[18] * x[9];
    val -= Lx[19] * x[10];
    val -= Lx[20] * x[11];
    val -= Lx[21] * x[12];
    val -= Lx[22] * x[13];
    val -= Lx[23] * x[14];
    val -= Lx[24] * x[15];
    x[8] = val;

   /*
    * i = 7
    * L_p[7] = 14, L_p[8] = 18
    */
    val = x[7];
    val -= Lx[14] * x[8];
    val -= Lx[15] * x[9];
    val -= Lx[16] * x[10];
    val -= Lx[17] * x[15];
    x[7] = val;

   /*
    * i = 6
    * L_p[6] = 10, L_p[7] = 14
    */
    val = x[6];
    val -= Lx[10] * x[8];
    val -= Lx[11] * x[9];
    val -= Lx[12] * x[10];
    val -= Lx[13] * x[15];
    x[6] = val;

   /*
    * i = 5
    * L_p[5] = 8, L_p[6] = 10
    */
    val = x[5];
    val -= Lx[8] * x[8];
    val -= Lx[9] * x[9];
    x[5] = val;

   /*
    * i = 4
    * L_p[4] = 6, L_p[5] = 8
    */
    val = x[4];
    val -= Lx[6] * x[8];
    val -= Lx[7] * x[9];
    x[4] = val;

   /*
    * i = 3
    * L_p[3] = 5, L_p[4] = 6
    */
    val = x[3];
    val -= Lx[5] * x[9];
    x[3] = val;

   /*
    * i = 2
    * L_p[2] = 4, L_p[3] = 5
    */
    val = x[2];
    val -= Lx[4] * x[8];
    x[2] = val;

   /*
    * i = 1
    * L_p[1] = 2, L_p[2] = 4
    */
    val = x[1];
    val -= Lx[2] * x[9];
    val -= Lx[3] * x[15];
    x[1] = val;

   /*
    * i = 0
    * L_p[0] = 0, L_p[1] = 2
    */
    val = x[0];
    val -= Lx[0] * x[8];
    val -= Lx[1] * x[10];
    x[0] = val;
}

void QDLDL_solve_st(QDLDL_float x[16]){

    static const QDLDL_float Dinv[16] = {-0.1               ,-0.1               ,-0.1               ,
 -0.1               ,-0.1               ,-0.1               ,
 -0.1               ,-0.1               , 0.6996529844635356,
  0.6996529844635359,10.043330856878885 , 2.9709475671764496,
  2.4499668596855684, 1.3131674763907761, 1.3121195997345045,
 12.189266687299826 };

    static const QDLDL_float Lx[46] = {-8.4412560172422491e-02,-1.0000000000000001e-01,-8.4412560172422435e-02,
 -1.0000000000000001e-01,-9.0262139179013504e-02,-9.0262139179013490e-02,
 -1.8419932005093724e-03, 8.9973053794359811e-02, 8.9973053794359811e-02,
  1.8419932005093705e-03,-3.4509424499973660e-03, 9.0023199159462372e-02,
 -1.2340540119918390e-03, 6.0277968439505294e-02, 9.0023199159462386e-02,
  3.4509424499973625e-03, 6.0277968439505274e-02, 1.2340540119918383e-03,
 -2.6853211115243162e-17, 5.5657623178565574e-01, 7.0190533295162449e-01,
 -3.8017187117784977e-02, 3.8698697403487403e-01,-3.2635982344516368e-02,
 -1.2537207461237244e-02, 1.2537207461237224e-02, 3.8017187117784935e-02,
  7.0190533295162449e-01, 3.2635982344516208e-02, 3.8698697403487559e-01,
  5.5657623178565629e-01, 8.4789676656238777e-01,-7.5486112811121650e-03,
  5.6148653626979939e-01,-2.4773436528121352e-02,-1.7422401814430064e-17,
  1.8933341059579705e-03, 5.6063330242114917e-01,-1.5563855424695690e-02,
  2.2329771507846310e-03, 1.8117227703657771e-02, 5.7843564670605740e-01,
  2.0683217481155139e-01, 5.8446923881599339e-05, 6.7730612382691457e-04,
  9.2965335979319306e-03};

    QDLDL_Lsolve_st(Lx, x);

    x[0] *= Dinv[0];
    x[1] *= Dinv[1];
    x[2] *= Dinv[2];
    x[3] *= Dinv[3];
    x[4] *= Dinv[4];
    x[5] *= Dinv[5];
    x[6] *= Dinv[6];
    x[7] *= Dinv[7];
    x[8] *= Dinv[8];
    x[9] *= Dinv[9];
    x[10] *= Dinv[10];
    x[11] *= Dinv[11];
    x[12] *= Dinv[12];
    x[13] *= Dinv[13];
    x[14] *= Dinv[14];
    x[15] *= Dinv[15];

    QDLDL_Ltsolve_st(Lx, x);
}

static inline void permute_x_st(QDLDL_float x[16], const QDLDL_float b[16]){
    /* Permute x = P*b using P */
    x[0] = b[10];
    x[1] = b[11];
    x[2] = b[8];
    x[3] = b[9];
    x[4] = b[13];
    x[5] = b[12];
    x[6] = b[15];
    x[7] = b[14];
    x[8] = b[0];
    x[9] = b[1];
    x[10] = b[2];
    x[11] = b[4];
    x[12] = b[5];
    x[13] = b[6];
    x[14] = b[7];
    x[15] = b[3];
}

static inline void permutet_x_st(QDLDL_float x[16], const QDLDL_float b[16]){
    /* Permute x = P'*b using P */
    x[10] = b[0];
    x[11] = b[1];
    x[8] = b[2];
    x[9] = b[3];
    x[13] = b[4];
    x[12] = b[5];
    x[15] = b[6];
    x[14] = b[7];
    x[0] = b[8];
    x[1] = b[9];
    x[2] = b[10];
    x[4] = b[11];
    x[5] = b[12];
    x[6] = b[13];
    x[7] = b[14];
    x[3] = b[15];
}

void LDLSolve_st(QDLDL_float *x, QDLDL_float *b, c_float *bp){
    /* Solves P'LDL'P x = b for x */
    permute_x_st(bp, b);
    QDLDL_solve_st(bp);
    permutet_x_st(x, bp);
}
